#! /usr/bin/env bash
# Michael Adams (mdadams@ece.uvic.ca)

cmd_dir=$(dirname "$0") || exit 1
source_dir="$cmd_dir/.."

panic()
{
	echo "ERROR: $@"
	exit 1
}

usage()
{
	echo "bad usage: $@"
	cat <<- EOF
	$0 -d install_dir -z github_ref
	EOF
	exit 2
}

install_dir=
github_ref=
spellcheck=0

while getopts d:z:s opt; do
	case $opt in
	d)
		install_dir="$OPTARG";;
	z)
		github_ref="$OPTARG";;
	s)
		spellcheck=1;;
	\?)
		usage
		break;;
	esac
done
shift $((OPTIND - 1))

if [ -z "$install_dir" ]; then
	usage "no output directory specified"
fi
if [ -z "$github_ref" ]; then
	usage "no github ref specified"
fi

version="$(awk -v FS="/" '{print $3;}' <<< "$github_ref")" || panic

if [ ! -d "$install_dir" ]; then
	mkdir -p "$install_dir" || panic
fi

(cd "$source_dir" && make clean) || panic

(cd "$source_dir" && \
  make DOC_VERSION="$version" DOC_SPELLCHECK_MUST_PASS="$spellcheck" all) || \
  panic

INSTALL_DIR="$install_dir" make install
#cp "$source_dir/guidelines.html" "$install_dir/index.html" || panic
#cp "$source_dir/pandoc.css" "$install_dir" || panic
